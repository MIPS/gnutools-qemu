From 72be9341fb31792ed649e5ce4ad879abc7b4f1a9 Mon Sep 17 00:00:00 2001
From: Vasileios Kalintiris <Vasileios.Kalintiris@imgtec.com>
Date: Sun, 19 Jun 2016 16:51:22 +0100
Subject: [PATCH 2/2] Bypass QEMU's execve emulation when the binary is the
 dynamic linker.

---
 linux-user/syscall.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/linux-user/syscall.c b/linux-user/syscall.c
index 2443883..571e705 100644
--- a/linux-user/syscall.c
+++ b/linux-user/syscall.c
@@ -5991,6 +5991,7 @@ abi_long do_syscall(void *cpu_env, int num, abi_long arg1,
             abi_ulong addr;
             char **q;
             int total_size = 0;
+            char *ld;
 
             argc = 0;
             guest_argp = arg2;
@@ -6041,7 +6042,11 @@ abi_long do_syscall(void *cpu_env, int num, abi_long arg1,
             if (!(p = lock_user_string(arg1)))
                 goto execve_efault;
 
-            ret = qemu_execve(p, argp, envp);
+            ld = strrchr(p, '/');
+            if (ld && !strcmp(ld, "/ld"))
+              ret = get_errno(execve(p, argp, envp));
+            else
+              ret = qemu_execve(p, argp, envp);
 
             unlock_user(p, arg1, 0);
 
-- 
2.8.2

